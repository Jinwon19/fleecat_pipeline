<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ - Fleecat Admin</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-row .btn {
            height: 38px;
            min-width: 120px;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .category-list {
            background: white;
            border-radius: 6px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .category-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item.depth-2 {
            margin-left: 30px;
            border-left-color: #28a745;
        }

        .category-item.depth-3 {
            margin-left: 60px;
            border-left-color: #ffc107;
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-depth1 {
            background: #007bff;
            color: white;
        }

        .badge-depth2 {
            background: #28a745;
            color: white;
        }

        .badge-depth3 {
            background: #ffc107;
            color: #333;
        }

        .category-actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ” Fleecat Admin</h2>
            </div>
            <nav>
                <ul class="sidebar-nav">
                    <li><a href="dashboard.html">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a></li>
                    <li><a href="members.html">ğŸ‘¥ íšŒì› ê´€ë¦¬</a></li>
                    <li><a href="tenants.html">ğŸª íŒë§¤ì‚¬ ê´€ë¦¬</a></li>
                    <li><a href="tenant-members.html">ğŸ‘” íŒë§¤ì‚¬ êµ¬ì„±ì› ê´€ë¦¬</a></li>
                    <li><a href="categories.html" class="active">ğŸ“‚ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</a></li>
                    <li><a href="products.html">ğŸ›ï¸ ìƒí’ˆ ê´€ë¦¬</a></li>
                    <li><a href="orders.html">ğŸ“¦ ì£¼ë¬¸ ê´€ë¦¬</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h1>
                <div class="page-actions">
                    <span id="userEmail"></span>
                    <button class="btn btn-secondary btn-sm" id="logoutButton">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <div id="alertBox" class="hidden"></div>

            <!-- 1. ëŒ€ë¶„ë¥˜ ë“±ë¡ -->
            <div class="section">
                <h2 class="section-title">1ï¸âƒ£ ëŒ€ë¶„ë¥˜ ë“±ë¡ (Depth 1)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>ëŒ€ë¶„ë¥˜ ì´ë¦„ *</label>
                        <input type="text" id="category1Name" class="form-control" placeholder="ì˜ˆ: ì˜ë¥˜, ì „ìê¸°ê¸°, ì‹í’ˆ">
                    </div>
                    <div class="form-group">
                        <label>ì„¤ëª… (ì„ íƒ)</label>
                        <input type="text" id="category1Description" class="form-control" placeholder="ì¹´í…Œê³ ë¦¬ ì„¤ëª…">
                    </div>
                    <button class="btn btn-primary" id="btnCategory1">ëŒ€ë¶„ë¥˜ ë“±ë¡</button>
                </div>
            </div>

            <!-- 2. ì¤‘ë¶„ë¥˜ ë“±ë¡ -->
            <div class="section">
                <h2 class="section-title">2ï¸âƒ£ ì¤‘ë¶„ë¥˜ ë“±ë¡ (Depth 2)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>ëŒ€ë¶„ë¥˜ ì„ íƒ *</label>
                        <select id="category1Select" class="form-control">
                            <option value="">ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì¤‘ë¶„ë¥˜ ì´ë¦„ *</label>
                        <input type="text" id="category2Name" class="form-control" placeholder="ì˜ˆ: ìƒì˜, í•˜ì˜, ì‹ ë°œ">
                    </div>
                    <div class="form-group">
                        <label>ì„¤ëª… (ì„ íƒ)</label>
                        <input type="text" id="category2Description" class="form-control" placeholder="ì¹´í…Œê³ ë¦¬ ì„¤ëª…">
                    </div>
                    <button class="btn btn-success" id="btnCategory2">ì¤‘ë¶„ë¥˜ ë“±ë¡</button>
                </div>
            </div>

            <!-- 3. ì†Œë¶„ë¥˜ ë“±ë¡ -->
            <div class="section">
                <h2 class="section-title">3ï¸âƒ£ ì†Œë¶„ë¥˜ ë“±ë¡ (Depth 3)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>ëŒ€ë¶„ë¥˜ ì„ íƒ *</label>
                        <select id="category1SelectFor3" class="form-control">
                            <option value="">ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì¤‘ë¶„ë¥˜ ì„ íƒ *</label>
                        <select id="category2SelectFor3" class="form-control">
                            <option value="">ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì†Œë¶„ë¥˜ ì´ë¦„ *</label>
                        <input type="text" id="category3Name" class="form-control" placeholder="ì˜ˆ: í‹°ì…”ì¸ , ì…”ì¸ , í›„ë“œí‹°">
                    </div>
                    <div class="form-group">
                        <label>ì„¤ëª… (ì„ íƒ)</label>
                        <input type="text" id="category3Description" class="form-control" placeholder="ì¹´í…Œê³ ë¦¬ ì„¤ëª…">
                    </div>
                    <button class="btn btn-warning" id="btnCategory3">ì†Œë¶„ë¥˜ ë“±ë¡</button>
                </div>
            </div>

            <!-- 4. ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ -->
            <div class="card">
                <div class="card-header">
                    ğŸ“‹ ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ (ê³„ì¸µí˜•)
                    <button class="btn btn-sm btn-secondary" id="refreshButton" style="margin-left: auto;">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="card-body">
                    <div id="categoryList" class="category-list">
                        <p class="text-center text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            loadAllCategories();
            loadCategory1Options();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('btnCategory1').addEventListener('click', registerCategory1);
            document.getElementById('btnCategory2').addEventListener('click', registerCategory2);
            document.getElementById('btnCategory3').addEventListener('click', registerCategory3);
            document.getElementById('refreshButton').addEventListener('click', loadAllCategories);

            document.getElementById('category1SelectFor3').addEventListener('change', loadCategory2For3);
        });

        // ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
        async function loadAllCategories() {
            try {
                const response = await apiCall('GET', '/api/v1/admin/categories?includeInactive=false');

                if (response.success) {
                    renderCategoryList(response.data);
                }
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ëŒ€ë¶„ë¥˜ ì˜µì…˜ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCategory1Options() {
            try {
                const response = await apiCall('GET', '/api/v1/admin/categories?includeInactive=false');

                if (response.success) {
                    // APIëŠ” ëŒ€ë¶„ë¥˜ë§Œ ë°˜í™˜ (child_categoriesì— ì¤‘/ì†Œë¶„ë¥˜ í¬í•¨)
                    const categories1 = response.data;
                    const options = categories1.map(cat =>
                        `<option value="${cat.category_id}">${cat.category_name}</option>`
                    ).join('');

                    document.getElementById('category1Select').innerHTML = '<option value="">ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' + options;
                    document.getElementById('category1SelectFor3').innerHTML = '<option value="">ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' + options;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // 1. ëŒ€ë¶„ë¥˜ ë“±ë¡
        async function registerCategory1() {
            const name = document.getElementById('category1Name').value.trim();
            const description = document.getElementById('category1Description').value.trim();

            if (!name) {
                showAlert('ëŒ€ë¶„ë¥˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await apiCall('POST', '/api/v1/admin/categories', {
                    category_name: name,
                    category_description: description || null,
                    category_order: 0,
                    parent_category_id: null
                });

                if (response.success) {
                    showAlert('âœ… ëŒ€ë¶„ë¥˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    document.getElementById('category1Name').value = '';
                    document.getElementById('category1Description').value = '';
                    loadCategory1Options();
                    loadAllCategories();
                } else {
                    showAlert(response.message || 'ë“±ë¡ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showAlert('ì„œë²„ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // 2. ì¤‘ë¶„ë¥˜ ë“±ë¡
        async function registerCategory2() {
            const parentId = document.getElementById('category1Select').value;
            const name = document.getElementById('category2Name').value.trim();
            const description = document.getElementById('category2Description').value.trim();

            if (!parentId) {
                showAlert('ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            if (!name) {
                showAlert('ì¤‘ë¶„ë¥˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await apiCall('POST', '/api/v1/admin/categories', {
                    category_name: name,
                    category_description: description || null,
                    category_order: 0,
                    parent_category_id: parseInt(parentId)
                });

                if (response.success) {
                    showAlert('âœ… ì¤‘ë¶„ë¥˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    document.getElementById('category2Name').value = '';
                    document.getElementById('category2Description').value = '';
                    loadAllCategories();
                } else {
                    showAlert(response.message || 'ë“±ë¡ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showAlert('ì„œë²„ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // 3-1. ì†Œë¶„ë¥˜ìš© ì¤‘ë¶„ë¥˜ ë¡œë“œ
        async function loadCategory2For3() {
            const parentId = document.getElementById('category1SelectFor3').value;
            const select = document.getElementById('category2SelectFor3');

            if (!parentId) {
                select.innerHTML = '<option value="">ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }

            try {
                const response = await apiCall('GET', '/api/v1/admin/categories?includeInactive=false');

                if (response.success) {
                    // ê³„ì¸µí˜• êµ¬ì¡°ì—ì„œ í•´ë‹¹ ëŒ€ë¶„ë¥˜ ì°¾ê¸°
                    const parent = response.data.find(cat => cat.category_id === parentId);

                    if (parent && parent.child_categories && parent.child_categories.length > 0) {
                        const categories2 = parent.child_categories;
                        select.innerHTML = '<option value="">ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' +
                            categories2.map(cat => `<option value="${cat.category_id}">${cat.category_name}</option>`).join('');
                    } else {
                        select.innerHTML = '<option value="">ì¤‘ë¶„ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // 3-2. ì†Œë¶„ë¥˜ ë“±ë¡
        async function registerCategory3() {
            const parentId = document.getElementById('category2SelectFor3').value;
            const name = document.getElementById('category3Name').value.trim();
            const description = document.getElementById('category3Description').value.trim();

            if (!parentId) {
                showAlert('ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            if (!name) {
                showAlert('ì†Œë¶„ë¥˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await apiCall('POST', '/api/v1/admin/categories', {
                    category_name: name,
                    category_description: description || null,
                    category_order: 0,
                    parent_category_id: parseInt(parentId)
                });

                if (response.success) {
                    showAlert('âœ… ì†Œë¶„ë¥˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    document.getElementById('category3Name').value = '';
                    document.getElementById('category3Description').value = '';
                    loadAllCategories();
                } else {
                    showAlert(response.message || 'ë“±ë¡ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showAlert('ì„œë²„ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ê³„ì¸µí˜• êµ¬ì¡°ë¥¼ í”Œë«í•œ ë°°ì—´ë¡œ ë³€í™˜ (ì¬ê·€)
        function flattenCategories(categories) {
            const result = [];

            function traverse(cats) {
                cats.forEach(cat => {
                    result.push(cat);
                    if (cat.child_categories && cat.child_categories.length > 0) {
                        traverse(cat.child_categories);
                    }
                });
            }

            traverse(categories);
            return result;
        }

        // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë Œë”ë§ (ê³„ì¸µí˜•)
        function renderCategoryList(categories) {
            const container = document.getElementById('categoryList');

            if (categories.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ê³„ì¸µí˜• êµ¬ì¡°ë¥¼ í”Œë«í•˜ê²Œ ë³€í™˜
            const flatCategories = flattenCategories(categories);

            // Depthë³„ë¡œ ì •ë ¬ (ì´ë¯¸ ê³„ì¸µ ìˆœì„œëŒ€ë¡œ ë˜ì–´ ìˆì§€ë§Œ, ì•ˆì „í•˜ê²Œ ì •ë ¬)
            const sorted = flatCategories.sort((a, b) => {
                // pathë¡œ ë¹„êµí•˜ì—¬ ê³„ì¸µ ìˆœì„œ ìœ ì§€
                return (a.category_path || '').localeCompare(b.category_path || '');
            });

            let html = '';
            sorted.forEach(cat => {
                const depthClass = `depth-${cat.category_depth}`;
                const badgeClass = `badge-depth${cat.category_depth}`;
                const depthLabel = cat.category_depth === 1 ? 'ëŒ€ë¶„ë¥˜' : cat.category_depth === 2 ? 'ì¤‘ë¶„ë¥˜' : 'ì†Œë¶„ë¥˜';

                html += `
                    <div class="category-item ${depthClass}">
                        <div class="category-info">
                            <span class="category-badge ${badgeClass}">${depthLabel}</span>
                            <strong>${cat.category_name}</strong>
                            ${cat.category_description ? `<span class="text-muted">- ${cat.category_description}</span>` : ''}
                            ${cat.category_path ? `<span class="text-muted text-sm">(${cat.category_path})</span>` : ''}
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-sm btn-primary" onclick="toggleCategory(${cat.category_id}, ${!cat.category_is_active})">
                                ${cat.category_is_active ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ì¹´í…Œê³ ë¦¬ í™œì„±í™”/ë¹„í™œì„±í™” í† ê¸€
        async function toggleCategory(categoryId, isActive) {
            try {
                const response = await apiCall('PATCH', `/api/v1/admin/categories/${categoryId}`, {
                    category_is_active: isActive
                });

                if (response.success) {
                    showAlert(`ì¹´í…Œê³ ë¦¬ê°€ ${isActive ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    loadAllCategories();
                } else {
                    showAlert(response.message || 'ë³€ê²½ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showAlert('ì„œë²„ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
            alertBox.textContent = message;
            alertBox.classList.remove('hidden');

            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 4000);
        }
    </script>
</body>
</html>
