# prompt_templates.py
"""
이 파일은 모든 GPT 프롬프트를 모듈화하여 관리합니다.
유지보수를 위해 프롬프트를 별도로 관리하고,
main.py에서는 import 해서 사용합니다.
"""

def get_text_prompt(raw_text: str, url: str, original_place: str = "", post_date: str = "") -> str:
    """텍스트 기반 플리마켓 정보 정제용 프롬프트"""
    # 원본 크롤링 장소 정보가 있으면 힌트 제공
    place_hint = ""
    if original_place and original_place.strip():
        place_hint = f"""
⚠️ 중요: 크롤링 원본 장소명 = "{original_place}"
- 이 정보가 건물명, 공원명, 특정 장소명이면 반드시 그대로 사용하세요!
- 불필요하게 번지수로 변환하지 마세요.
- 원본 장소명이 카카오맵에서 검색 가능한 정확한 정보라면 그대로 사용하는 것이 최선입니다.

"""

    # 게시글 작성일 정보가 있으면 연도 추론에 활용
    post_date_hint = ""
    if post_date and post_date.strip():
        post_date_hint = f"""
⚠️ 중요: 게시글 작성일 = "{post_date}"
- 게시글이 작성된 날짜를 기반으로 이벤트 날짜의 연도를 정확히 추론하세요.
- 연도가 없는 이벤트 날짜(예: "10월 25일~26일")는 게시글 작성일의 연도를 사용하세요.
- 단, 게시글 작성월(예: 12월)보다 이벤트 월(예: 3월)이 이전이면 다음해로 추론하세요.

**예시:**
- 게시글 작성일: 2025-10-29, 이벤트: "10월 25일~26일" → 2025-10-25 ~ 2025-10-26
- 게시글 작성일: 2025-12-20, 이벤트: "3월 15일" → 2026-03-15 (다음해)
- 게시글 작성일: 2025-10-02, 이벤트: "9월 24일" → 2026-09-24 (이미 지난 날짜는 다음해)

"""

    return f"""
너는 한국어 플리마켓 게시글을 분석해 **카카오맵에서 검색 가능한 구조화된 데이터**를 생성하는 AI 전문가야.
{place_hint}{post_date_hint}
[핵심 목표]
1. 아래 게시글에서 플리마켓 정보를 추출
2. **카카오맵 API에서 검색 가능한 장소명** 또는 **완전한 주소** 추출 (가장 중요!)
3. 모든 필드를 채워서 JSON으로 반환 (빈 값 절대 금지)

[출력 JSON 형식]
{{
  "market_name": "행사명 (절대 생략하지 말 것)",
  "place": "카카오맵 검색 가능한 장소명 또는 주소 (매우 중요!)",
  "url": "{url}",
  "sessions": [
    {{
      "start_date": "YYYY-MM-DD",
      "end_date": "YYYY-MM-DD",
      "start_time": "HH:mm",
      "end_time": "HH:mm",
      "notes": "비고"
    }}
  ]
}}

[중요 규칙 1: 장소명 추출 (가장 중요! 반드시 따를 것)]

⚠️ **절대 금지 사항 (이를 위반하면 즉시 실패):**
- 플레이스홀더나 템플릿 문자열 절대 출력 금지
- **"미정", "추후 공지", "TBD", "미확정", "확인중", "조율중" 같은 문자열 절대 출력 금지**
- **정보가 불완전하거나 확실하지 않으면 반드시 빈 문자열("")로 출력**
- "서울", "홍대", "강남"처럼 지역명만 출력 금지
- 괄호 () 안의 층수나 부가 설명 포함 금지
- 장소를 알 수 없으면 place를 빈 문자열("")로 출력
- 날짜/시간을 알 수 없으면 해당 필드를 빈 문자열("")로 출력
- **텍스트가 잘려있거나 불완전해도 추측하지 말고 빈 문자열("")로 출력**

✅ **올바른 장소명 추출 전략:**

1. **완전한 주소가 있으면 우선 추출** (도로명 주소 > 지번 주소)
   - 입력: "서울특별시 마포구 도화동 553-1번지 (용강동상점가 2층)"
   - 출력: "서울특별시 마포구 도화동 553-1"

   - 입력: "경기도 평택시 포승읍 평택항로 184 (국제여객터미널)"
   - 출력: "경기도 평택시 포승읍 평택항로 184"

2. **건물명/장소명이 있으면 지역 + 건물명 추출**
   - 입력: "홍대입구역 9번 출구 앞 광장 (KT&G 상상마당 앞)"
   - 출력: "서울 마포구 홍대입구역 9번 출구"

   - 입력: "망원한강공원 축구장 옆 (파란색 천막)"
   - 출력: "서울 마포구 망원한강공원"

   - 입력: "강남역 11번 출구 CGV 건물 3층"
   - 출력: "서울 강남구 강남역 11번 출구"

3. **유명 건물/공원/광장이면 그대로 추출** (단, 시/구는 반드시 포함)
   - 입력: "대전 대덕구 송촌동 문화센터 3층 로비"
   - 출력: "대전 대덕구 송촌동 문화센터"

   - 입력: "진천군 진천읍 농업혁신성 1층 로비"
   - 출력: "충북 진천군 진천읍 농업혁신성"

   - 입력: "수원시 영통구 영통동 아이파크 캐슬"
   - 출력: "경기도 수원시 영통구 영통동 아이파크캐슬"

4. **지하철역 근처인 경우**
   - 입력: "홍대입구역 근처에서 진행"
   - 출력: "서울 마포구 홍대입구역"

   - 입력: "강남역 부근"
   - 출력: "서울 강남구 강남역"

5. **정말 알 수 없는 경우만** 빈 문자열로 출력
   - 입력: "장소 추후 공지"
   - 출력: ""

[중요 규칙 2: 날짜 및 시간]

1. **날짜는 "YYYY-MM-DD" 형식 (ISO 8601)**
   - 연도가 없으면 게시글 작성일을 기준으로 추론 (위 게시글 작성일 정보 참고)
   - 게시글 작성일이 없는 경우에만 현재 연도(2025년) 사용
   - 입력: "10월 25일~26일" (게시글 작성일: 2025-10-02) → "2025-10-25" ~ "2025-10-26"
   - 입력: "3월 15일" (게시글 작성일: 2025-12-20) → "2026-03-15" (다음해)

2. **시간은 "HH:mm" (24시간제)**
   - "오후 2시" → "14:00"
   - "낮 12시" → "12:00"
   - "저녁 6시 반" → "18:30"
   - "11시부터 18시까지" → start_time: "11:00", end_time: "18:00"

3. **여러 날짜가 있으면 sessions 배열로 분리**
   - 입력: "10월 25일, 11월 3일, 11월 10일"
   - 출력:
   ```json
   "sessions": [
     {{"start_date": "2025-10-25", "end_date": "2025-10-25", ...}},
     {{"start_date": "2025-11-03", "end_date": "2025-11-03", ...}},
     {{"start_date": "2025-11-10", "end_date": "2025-11-10", ...}}
   ]
   ```

[중요 규칙 3: 데이터 검증]

출력 전 다음을 확인하세요:
1. ✅ "place" 필드가 플레이스홀더 텍스트가 아닌가?
2. ✅ "place" 필드가 지역명만 있지 않은가? (예: "서울", "홍대", "강남")
3. ✅ "place" 필드에 괄호 ()가 없는가?
4. ✅ 날짜 형식이 "YYYY-MM-DD"인가?
5. ✅ 시간 형식이 "HH:mm"인가?

⚠️ 위 검증 중 하나라도 실패하면 다시 작성하세요!

[출력 형식]
- **반드시 JSON만 출력** (설명, 주석, 마크다운 코드블록 금지)
- 예시:
```json
{{
  "market_name": "2025 아니 근데 진짜? 마포역 용강동상점가 플리마켓 시즌4",
  "place": "서울특별시 마포구 도화동 553-1",
  "url": "{url}",
  "sessions": [
    {{
      "start_date": "2025-10-25",
      "end_date": "2025-10-26",
      "start_time": "14:00",
      "end_time": "18:00",
      "notes": ""
    }}
  ]
}}
```

[게시글 원문]
---
{raw_text}
---

✅ 위 원문을 분석하여 **검증된 JSON**을 생성하세요. (설명 없이 JSON만 출력!)
"""


def get_image_prompt() -> str:
    """이미지(OCR)용 프롬프트"""
    return """
이 이미지는 플리마켓 행사 포스터입니다.
다음 정보를 최대한 정확히 추출하여 JSON으로 반환하세요.

- market_name: 행사명
- place: 장소명 또는 주소
- date_info: 날짜 (모든 날짜를 텍스트 그대로)
- time_info: 시간 정보 (예: "12:00-18:00", "오후 1시~6시")

규칙:
1. 시간 표현(오전, 오후, ~, -, :)이 포함된 문자열을 찾아주세요.
2. 정보가 없으면 빈 문자열("")로 반환.
3. JSON만 반환 (설명 금지).
"""


def get_refine_prompt(market_name: str, place: str, url: str, date_info: str, time_info: str) -> str:
    """이미지 정보와 텍스트 정보를 결합해 최종 보정용 프롬프트"""
    return f"""
아래의 정보를 기반으로 완전한 JSON을 작성하세요.

행사명: {market_name}
장소: {place}
추가정보:
- 날짜: {date_info}
- 시간: {time_info}

[출력 규칙]
1. 날짜는 YYYY-MM-DD
2. 시간은 24시간제 (HH:mm)
3. "오후 2시" → "14:00", "12시~6시" → "12:00~18:00"
4. 값이 불확실하면 추정값을 채우되 빈 값은 절대 남기지 말 것.

[출력 형식]
{{
  "market_name": "{market_name}",
  "place": "{place}",
  "url": "{url}",
  "sessions": [
    {{
      "start_date": "YYYY-MM-DD",
      "end_date": "YYYY-MM-DD",
      "start_time": "HH:mm",
      "end_time": "HH:mm",
      "notes": "추정값 포함 가능"
    }}
  ]
}}
"""
